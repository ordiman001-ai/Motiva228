<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный Центр Развития</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
            --secondary-color: #8b5cf6; /* Violet-500 */
            --bg-color: #f8f8fb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            transition: all 0.3s ease;
        }
        .tab-button {
            transition: all 0.2s;
            padding: 0.75rem 1.5rem;
            margin-right: 0.5rem;
            border-radius: 0.75rem 0.75rem 0 0;
            white-space: nowrap;
            color: #6b7280; /* Gray-500 */
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
            background-color: #ffffff;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }
        .tab-button:not(.active):hover {
            color: #6366f1; /* Indigo-500 */
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e0e0f0;
        }
        .task-card, .challenge-card, .sleep-day-card {
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.3s;
        }
        .task-card:hover:not(.completed) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05);
        }
        .library-content {
            line-height: 1.8;
            text-align: justify;
        }
        .chat-message-user {
            background-color: #eef2ff; /* Indigo-50 */
            border-bottom-right-radius: 0;
        }
        .chat-message-ai {
            background-color: #f0fdf4; /* Emerald-50 */
            border-bottom-left-radius: 0;
        }
        .sleep-day-card.completed {
            opacity: 0.7;
            background-color: #eef2ff;
        }
        .task-card.completed {
            opacity: 0.7;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-7xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 transition-all duration-500 min-h-[85vh] flex flex-col">

        <!-- Header and Navigation -->
        <header class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-indigo-700">Личный Центр Развития</h1>
            <span id="user-id-display" class="text-sm font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full hidden sm:inline-block">ID: автономный</span>
        </header>

        <!-- Top Navigation (Tabs) -->
        <nav id="app-navigation" class="border-b mb-6 overflow-x-auto whitespace-nowrap -mt-4">
            <!-- Tabs will be rendered here -->
        </nav>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-grow custom-scrollbar overflow-y-auto pt-2">
            <!-- Content will be rendered here dynamically -->
            <div id="loading-indicator" class="text-center p-10 text-lg font-medium text-indigo-500">
                <i class="fas fa-spinner fa-spin mr-2"></i> Инициализация приложения...
            </div>
        </div>

    </div>

    <!-- Modal for User Feedback (non-alert) -->
    <div id="app-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
            <h4 id="modal-title" class="text-2xl font-bold text-indigo-600 mb-4"></h4>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button onclick="document.getElementById('app-modal').classList.add('hidden')" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors">
                Понятно
            </button>
        </div>
    </div>

    <!-- Modal for "Give Up" Explanation (Task Failure) -->
    <div id="give-up-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full">
            <h4 class="text-2xl font-bold text-red-600 mb-4 flex items-center">
                <i class="fas fa-hand-paper mr-2"></i> Почему вы сдаетесь?
            </h4>
            <p class="text-gray-700 mb-6">Ваш тренер хочет вам помочь! Пожалуйста, объясните, с какой проблемой вы столкнулись при выполнении задания.</p>
            <form id="give-up-form">
                <textarea id="give-up-explanation" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 mb-6" placeholder="Например: 'У меня не хватило времени из-за работы', 'Задание оказалось слишком сложным' или 'Я забыл о нем.'"></textarea>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="document.getElementById('give-up-modal').classList.add('hidden'); window.appState.currentGiveUpTask = null;" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-xl hover:bg-gray-300 transition-colors">
                        Отмена
                    </button>
                    <button type="submit" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition-colors">
                        Сдаться и получить помощь
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- Core Data Structures (Constants) ---

        const SPHERES = {
            health: 'Здоровье',
            sport: 'Спорт',
            communication: 'Общение',
            learning: 'Обучение и Развитие'
        };

        const TRAINERS = {
            aurora: { name: 'Аврора', role: 'Подруга-поддержка', icon: 'fa-regular fa-face-smile-wink', color: 'text-pink-500', bg: 'bg-pink-100', description: 'Ваш эмоциональный интеллект, всегда готовый поддержать и вдохновить с мягкостью.' },
            johnny: { name: 'Джонни', role: 'Строгий тренер', icon: 'fa-solid fa-graduation-cap', color: 'text-red-600', bg: 'bg-red-100', description: 'Ваш аналитик и мотиватор, который требует системности и отчитывает за прокрастинацию.' },
            silas: { name: 'Сайлас', role: 'Мудрец-философ', icon: 'fa-solid fa-feather-pointed', color: 'text-indigo-600', bg: 'bg-indigo-100', description: 'Ваш наставник, который помогает смотреть на вещи с высоты птичьего полета и видеть смысл.' },
        };

        const TABS = [
            { id: 'home', name: 'Главная', icon: 'fas fa-home' },
            { id: 'tasks', name: 'Задачи', icon: 'fas fa-tasks' },
            { id: 'challenges', name: 'Челленджи', icon: 'fas fa-running' },
            { id: 'healthy_sleep', name: 'Здоровый сон (28 дней)', icon: 'fas fa-bed' },
            { id: 'library', name: 'Библиотека', icon: 'fas fa-book-reader' },
            { id: 'chat', name: 'Тренер AI', icon: 'fas fa-comments' },
        ];

        const MOTIVATIONAL_PHRASES = [
            "Каждый день – это чистый лист. Напиши свою лучшую историю!",
            "Успех — это сумма маленьких усилий, повторяющихся изо дня в день.",
            "Начинай с малого, но начинай сейчас. Идеального момента не существует.",
            "Ты сильнее, чем думаешь. Докажи это себе сегодня!",
            "Твоя энергия определяет твое будущее. Инвестируй в нее wisely.",
            "Философия: не спрашивай, что мир может сделать для тебя, а спроси, что ты можешь сделать, чтобы изменить свой мир.",
            "Дисциплина — это мост между целями и их достижением.",
            "Верь в себя. Ты уже прошел 100% самых трудных дней в своей жизни.",
        ];

        const CHALLENGES_DATA = [
            { id: 'C1', name: 'Цифровой Детокс', duration: 3, focus: 'Осознанность',
                steps: [
                    'Уберите телефон из спальни (заряжайте в другой комнате).',
                    'Отключите все уведомления (кроме звонков) на весь день.',
                    'Один час без телефона после пробуждения и за час до сна.'
                ]},
            { id: 'C2', name: '7 Дней Без Сахара', duration: 7, focus: 'Питание',
                steps: [
                    'Полностью исключите явный сахар и кондитерские изделия.',
                    'Исключите сладкие напитки (соки, газировка).',
                    'Если хочется сладкого, используйте фрукты или ягоды.'
                ]},
            { id: 'C3', name: 'Ежедневная Благодарность', duration: 5, focus: 'Мышление',
                steps: [
                    'Утром записывайте 3 вещи, за которые вы благодарны.',
                    'Вечером вспоминайте 1 позитивный момент дня.',
                    'Поделитесь благодарностью с кем-то из близких.'
                ]},
            { id: 'C4', name: 'Водный Баланс', duration: 10, focus: 'Здоровье',
                steps: [
                    'Выпивайте 2.5 литра чистой воды в день.',
                    'Начните день со стакана воды.',
                    'Замените все напитки (чай, кофе) чистой водой после 18:00.'
                ]},
        ];

        const SLEEP_PLAN = [
            { day: 1, title: 'Режим — это сила', task: 'Установите и придерживайтесь одного и того же времени отхода ко сну и пробуждения (+/- 15 минут) на сегодня.', benefit: 'Это помогает настроить ваши циркадные ритмы, делая пробуждение естественным и энергичным.' },
            { day: 2, title: 'Уберите кофеин', task: 'Исключите потребление кофе, крепкого чая и энергетиков после 14:00.', benefit: 'Кофеин остается в организме до 10 часов, мешая глубоким фазам сна. Ранний отказ обеспечит спокойствие.' },
            { day: 3, title: 'Очистка спальни', task: 'Сделайте вашу спальню максимально темной, тихой и прохладной. Оптимальная температура - $18-20^\circ \text{C}$.', benefit: 'Эти условия критически важны для выработки мелатонина (гормона сна) и повышения качества сна.' },
            { day: 4, title: 'Цифровой закат', task: 'Отключите все экраны (телефон, ТВ, планшет) за 60 минут до сна.', benefit: 'Синий свет подавляет мелатонин. Замена экранов на книгу или медитацию ускорит засыпание.' },
            { day: 5, title: 'Ритуал расслабления', task: 'Создайте 15-минутный расслабляющий ритуал: теплая ванна, легкая растяжка или чтение книги.', benefit: 'Мозг нуждается в сигнале о переходе к отдыху. Ритуал снижает уровень кортизола (гормона стресса).' },
            { day: 6, title: 'Дневник сновидений', task: 'Держите блокнот рядом с кроватью и записывайте туда тревожные мысли или идеи перед сном.', benefit: 'Помогает "выгрузить" беспокойства из головы, предотвращая мысленную жвачку, мешающую сну.' },
            { day: 7, title: 'Обед без тяжести', task: 'Избегайте тяжелой, острой или жирной пищи за 3 часа до сна. Разрешен легкий перекус.', benefit: 'Пищеварение требует энергии, которая должна идти на восстановление. Легкий желудок способствует глубокому сну.' },
            { day: 8, title: 'Минимум жидкости', task: 'Сведите к минимуму потребление жидкости за 2 часа до сна, чтобы избежать ночных пробуждений.', benefit: 'Предотвращение походов в туалет ночью сохранит циклы глубокого сна.' },
            { day: 9, title: 'Прогулка днем', task: 'Проведите 30 минут на солнечном свете в первой половине дня.', benefit: 'Яркий свет днем помогает "сбросить" циркадные часы и гарантирует сильное желание спать вечером.' },
            { day: 10, title: 'Уберите часы', task: 'Уберите из поля зрения все часы (аналоговые и цифровые), когда ложитесь спать.', benefit: 'Постоянное отслеживание времени вызывает стресс и бессонницу. Уменьшение тревоги.' },
            { day: 11, title: '15 минут медитации', task: 'Попробуйте 15-минутную медитацию или дыхательное упражнение прямо в постели.', benefit: 'Снижает частоту сердечных сокращений и успокаивает нервную систему перед засыпанием.' },
            { day: 12, title: 'Нет алкоголю', task: 'Полностью откажитесь от алкоголя сегодня. Даже небольшие дозы нарушают качество сна.', benefit: 'Алкоголь нарушает REM-фазу, что приводит к поверхностному и невосстанавливающему сну.' },
            { day: 13, title: 'Закрепление ритуала', task: 'Выполните свой вечерний ритуал (День 5) на 5 минут дольше, чтобы закрепить привычку.', benefit: 'Повторение и небольшое усложнение укрепляет нейронные связи.' },
            { day: 14, title: 'Сонник в голове', task: 'Используйте кровать только для сна и секса. Никакой работы, чтения или просмотра ТВ.', benefit: 'Создает сильную ассоциацию "кровать = сон" в вашем мозгу, улучшая скорость засыпания.' },
            { day: 15, title: 'Работа с шумом', task: 'Используйте "белый шум" (white noise) или беруши, если вас беспокоят внешние звуки.', benefit: 'Маскирует резкие звуки, которые могут вырвать вас из глубокого сна.' },
            { day: 16, title: 'Зарядка утром', task: 'Сделайте короткую физическую зарядку (5-10 минут) сразу после пробуждения.', benefit: 'Помогает организму полностью проснуться и запускает метаболизм.' },
            { day: 17, title: 'Мини-цель на день', task: 'Напишите три главные цели на завтрашний день, чтобы освободить мозг перед сном.', benefit: 'Снижает ментальное пережевывание и тревогу по поводу предстоящих дел.' },
            { day: 18, title: 'Дневной сон', task: 'Если нужен дневной сон, то строго не более 30 минут и до 15:00.', benefit: 'Длинный или поздний дневной сон нарушает ночной режим.' },
            { day: 19, title: 'Ароматерапия', task: 'Используйте лавандовое масло или другой расслабляющий аромат в спальне.', benefit: 'Некоторые запахи могут сигнализировать мозгу о безопасности и расслаблении.' },
            { day: 20, title: 'Теплые носки', task: 'Наденьте теплые носки, чтобы улучшить кровообращение и снизить температуру тела, что способствует сну.', benefit: 'Охлаждение центрального тела — важный сигнал для начала сна.' },
            { day: 21, title: 'Гигиена подушек', task: 'Поменяйте наволочку и проветрите одеяло. Чистота повышает качество отдыха.', benefit: 'Чистая, свежая среда улучшает ощущение комфорта и расслабления.' },
            { day: 22, title: 'Физическая нагрузка', task: 'Убедитесь, что сегодня у вас была умеренная физическая нагрузка (30-45 минут).', benefit: 'Физическая активность повышает "давление сна" и гарантирует более глубокий сон.' },
            { day: 23, title: 'Восстановление режима', task: 'Если вы сбились с режима, сегодня вернитесь к нему строго.', benefit: 'Контроль — это ключ. Однократное нарушение не должно перечеркивать прогресс.' },
            { day: 24, title: 'Двойной контроль темноты', task: 'Проверьте, что в спальне нет ни одного светящегося диода (даже от зарядки).', benefit: 'Микропробуждения от света нарушают структуру сна.' },
            { day: 25, title: 'Растяжка перед сном', task: 'Выполните 10 минут очень медленной и легкой растяжки, фокусируясь на дыхании.', benefit: 'Снимает мышечное напряжение, накопившееся за день.' },
            { day: 26, title: 'Чтение перед сном', task: 'Чтение физической книги или использование E-Ink ридера (без подсветки).', benefit: 'Отвлекает от проблем дня и готовит мозг к отдыху без вреда синего света.' },
            { day: 27, title: 'Самоанализ', task: 'Оцените свой прогресс за 27 дней. Что работает лучше всего?', benefit: 'Осознание эффективности привычек укрепляет внутреннюю мотивацию.' },
            { day: 28, title: 'Новый образ жизни', task: 'Соблюдите все правила: режим, темнота, ритуал, отсутствие кофеина и экранов.', benefit: 'Вы сформировали новую, здоровую привычку! Наслаждайтесь жизнью, полной энергии.' },
        ];


        const TASKS_DATA = {
            health: [
                { id: 'H1', level: 1, text: 'Выпейте 2 литра чистой воды за день (отметьте факт выполнения).' },
                { id: 'H2', level: 1, text: 'Ложитесь спать на 30 минут раньше обычного 3 дня подряд.' },
                { id: 'H3', level: 2, text: 'Замените один прием пищи салатом (из свежих овощей) хотя бы один раз.' },
                { id: 'H4', level: 2, text: 'В течение недели каждый день делайте перерыв на 10 минут ходьбы (для тех, кто работает сидя).' },
                { id: 'H5', level: 3, text: 'Полностью исключите сахар и сахаросодержащие напитки на 48 часов.' },
                { id: 'H6', level: 3, text: 'Освойте 5-минутную дыхательную практику и выполните ее утром и вечером.' },
                { id: 'H7', level: 4, text: 'Ведите дневник питания 7 дней, не внося изменений, чтобы оценить текущий рацион.' },
                { id: 'H8', level: 4, text: 'Сделайте один день в неделю «цифровым детоксом» (без социальных сетей/развлекательных медиа).' },
                { id: 'H9', level: 5, text: 'Приготовьте 3 новых, здоровых блюда из разных категорий (например, суп, рыба, запеканка).' },
                { id: 'H10', level: 5, text: 'Проведите 15 минут на свежем воздухе сразу после пробуждения.' },
                { id: 'H11', level: 6, text: 'Сделайте полный чек-ап своего здоровья (при условии, что это безопасно и доступно).' },
                { id: 'H12', level: 6, text: 'Практикуйте «интуитивное питание» один день: ешьте, только когда голодны, и останавливайтесь, когда сыты.' },
                { id: 'H13', level: 7, text: 'Разработайте и строго следуйте своему идеальному режиму дня (сон, работа, отдых) в течение двух недель.' },
                { id: 'H14', level: 7, text: 'Изучите свои макронутриенты (белки, жиры, углеводы) и скорректируйте их для достижения цели.' },
                { id: 'H15', level: 7, text: 'Попробуйте 12-часовое интервальное голодание (например, не есть с 20:00 до 8:00).' },
            ],
            sport: [
                { id: 'S1', level: 1, text: 'Выполните 10 отжиманий ИЛИ 15 приседаний за один подход.' },
                { id: 'S2', level: 1, text: 'Сделайте ежедневную 5-минутную разминку для суставов в течение 3 дней.' },
                { id: 'S3', level: 2, text: 'Прогуляйтесь 30 минут в быстром темпе.' },
                { id: 'S4', level: 2, text: 'Освойте правильную технику планки (держать 30 секунд).' },
                { id: 'S5', level: 3, text: 'Пробегите 1 километр без остановки.' },
                { id: 'S6', level: 3, text: 'Найдите 3 разных упражнения для спины и выполните их по 10 повторений.' },
                { id: 'S7', level: 4, text: 'Выполните тренировку HIIT (высокоинтенсивную интервальную тренировку) продолжительностью 20 минут.' },
                { id: 'S8', level: 4, text: 'Увеличьте количество приседаний до 50 за день (можно в несколько подходов).' },
                { id: 'S9', level: 5, text: 'Пробегите 3 километра. Замерьте время и запишите его.' },
                { id: 'S10', level: 5, text: 'Запишитесь на пробное занятие по новому виду спорта (например, йога, скалолазание, единоборства).' },
                { id: 'S11', level: 6, text: 'Тренируйтесь 5 дней подряд, делая акцент на разные группы мышц.' },
                { id: 'S12', level: 6, text: 'Изучите основы питания до и после тренировки.' },
                { id: 'S13', level: 7, text: 'Составьте полноценный 4-недельный тренировочный план и начните следовать ему.' },
                { id: 'S14', level: 7, text: 'Пробегите 5 километров без остановок. Это ваша цель!' },
                { id: 'S15', level: 7, text: 'Научитесь делать 10 чистых подтягиваний (или 5, если вы девушка).' },
            ],
            communication: [
                { id: 'C16', level: 1, text: 'Поздоровайтесь и улыбнитесь трем незнакомым людям (например, кассиру, соседу).' },
                { id: 'C17', level: 1, text: 'Похвалите кого-то искренне за что-то конкретное (внешность, работу).' },
                { id: 'C18', level: 2, text: 'Начните короткий, не обязывающий разговор (например, о погоде) с новым человеком.' },
                { id: 'C19', level: 2, text: 'Активно слушайте своего собеседника, не перебивая, в течение 10 минут.' },
                { id: 'C20', level: 3, text: 'Спросите у кого-то совета или рекомендации по поводу фильма/книги/места.' },
                { id: 'C21', level: 3, text: 'Напишите сообщение тому, с кем давно не общались, и спросите, как дела.' },
                { id: 'C22', level: 4, text: 'Познакомьтесь с новым человеком и поговорите с ним не менее 5 минут.' },
                { id: 'C23', level: 4, text: 'Задайте 5 открытых вопросов во время разговора (начинаются со слов "Как", "Почему", "Что").' },
                { id: 'C24', level: 5, text: 'Защитите свое мнение в споре или дискуссии, используя 3 аргумента.' },
                { id: 'C25', level: 5, text: 'Сделайте комплимент, используя 3 разных слова, описывающих одно качество.' },
                { id: 'C26', level: 6, text: 'Попросите о чем-то, что вызывает у вас дискомфорт (например, о скидке, о помощи).' },
                { id: 'C27', level: 6, text: 'Проведите 30-минутный разговор, не используя слова-паразиты.' },
                { id: 'C28', level: 7, text: 'Выступите с 5-минутной импровизированной речью на случайную тему перед аудиторией (даже небольшой).' },
                { id: 'C29', level: 7, text: 'Помогите двум людям познакомиться друг с другом, выступив посредником.' },
                { id: 'C30', level: 7, text: 'Организуйте небольшую встречу/мероприятие для группы людей.' },
            ],
            learning: [
                { id: 'L16', level: 1, text: 'Прочитайте 10 страниц книги по теме, в которой вы хотите развиваться.' },
                { id: 'L17', level: 1, text: 'Посмотрите 10-минутное образовательное видео и запишите 3 ключевых вывода.' },
                { id: 'L18', level: 2, text: 'Посвятите 30 минут изучению нового навыка (например, языка, инструмента, кода).' },
                { id: 'L19', level: 2, text: 'Изучите один новый термин или концепцию, связанную с вашей сферой деятельности.' },
                { id: 'L20', level: 3, text: 'Напишите короткий обзор (200 слов) о том, что вы недавно узнали.' },
                { id: 'L21', level: 3, text: 'Составьте список из 5 книг/курсов, которые помогут вам достичь долгосрочной цели.' },
                { id: 'L22', level: 4, text: 'Объясните новую сложную концепцию другому человеку простыми словами.' },
                { id: 'L23', level: 4, text: 'Создайте "карту знаний" (mind map) по новой теме.' },
                { id: 'L24', level: 5, text: 'Выделите 2 часа на глубокое изучение одного подраздела (без отвлечений).' },
                { id: 'L25', level: 5, text: 'Начните вести журнал обучения, чтобы отслеживать свой прогресс и трудности.' },
                { id: 'L26', level: 6, text: 'Примените на практике новый навык или знание, которое вы изучали (сделайте что-то реальное).' },
                { id: 'L27', level: 6, text: 'Пройдите полный модуль онлайн-курса и выполните все практические задания.' },
                { id: 'L28', level: 7, text: 'Завершите онлайн-курс/сертификацию, связанную с вашей карьерой.' },
                { id: 'L29', level: 7, text: 'Разработайте план обучения на ближайшие 6 месяцев с конкретными, измеримыми целями.' },
                { id: 'L30', level: 7, text: 'Напишите небольшую статью/эссе (1000 слов), обобщающую знания по новой теме.' },
            ],
        };

        const LIBRARY_DATA = {
            'Книга 1': { title: 'Искусство Мыслить Ясно', author: 'Рольф Добелли', content: `
                <h4 class="text-xl font-semibold mb-3">О книге:</h4>
                <p class="mb-4">Эта книга — навигатор по ловушкам мышления, которые ежедневно ставят нам палки в колеса. Добелли, опираясь на психологию и экономику, собрал 52 когнитивных искажения, которые мешают принимать рациональные решения. Цель книги — научить читателя узнавать эти ошибки в своих рассуждениях и, главное, избегать их. В отличие от тяжеловесных академических трудов, книга написана в легкой, афористичной манере, где каждое искажение описано на двух страницах и снабжено примером из жизни.</p>
                <h4 class="text-xl font-semibold mb-3">Ключевые идеи и цитаты (фрагмент):</h4>
                <p class="library-content">
                    **Ошибка выжившего:** Мы систематически переоцениваем шансы на успех, потому что на виду остаются только "выжившие" — успешные люди, компании или проекты. Мы не видим огромного кладбища провалившихся идей, поэтому склонны к необоснованному оптимизму. Это искажение особенно опасно в стартапах и инвестициях. Мы смотрим на Билла Гейтса и Марка Цукерберга, но игнорируем миллионы людей, которые пытались, но не смогли. Урок: анализируйте не только успех, но и неудачу.
                    <br><br>
                    **Иллюзия тела пловца:** Занимаемся ли мы плаванием, потому что у нас идеальное тело, или у нас идеальное тело, потому что мы занимаемся плаванием? Важно различать причину и следствие. Реклама часто показывает нам счастливых людей с определенными продуктами, создавая иллюзию, что продукт — причина счастья. На самом деле, часто это просто корреляция или полностью обратная связь. Спросите себя: что является первопричиной успеха?
                    <br><br>
                    **Склонность к подтверждению:** Мы ищем информацию, которая подтверждает наши существующие убеждения, и игнорируем или недооцениваем ту, что им противоречит. Это фильтр, через который мы воспринимаем мир. Если вы верите в эффективность диеты, вы будете искать истории успеха, а не научные опровержения. Чтобы развиваться, нужно активно искать опровергающие данные — это болезненно, но необходимо для объективности. Как сказал один философ, "самое большое препятствие для открытия — это не невежество, а иллюзия знания."
                    <br><br>
                    **Эффект контраста:** Мы оцениваем вещи не по абсолютной шкале, а по сравнению с тем, что находится рядом. Небольшая скидка кажется огромной, если она следует за очень дорогим товаром. Это часто используется в продажах и переговорах. Чтобы избежать этой ловушки, всегда используйте абсолютные метрики и игнорируйте контекст, созданный для манипуляции.
                    <br><br>
                    **Проблема с нулевым риском:** Мы склонны тратить много ресурсов на полное устранение минимального риска, в то время как эти ресурсы могли бы быть потрачены на значительное сокращение более крупного риска. Люди предпочитают нулевой риск, даже если это иррационально с точки зрения общей безопасности. Научитесь принимать небольшие остаточные риски, чтобы максимизировать общую выгоду и безопасность.
                </p>
            `, quotes: ['Анализируйте не только успех, но и неудачу.'] },
            'Книга 2': { title: 'Поток: Психология оптимального переживания', author: 'Михай Чиксентмихайи', content: `
                <h4 class="text-xl font-semibold mb-3">О книге:</h4>
                <p class="mb-4">Чиксентмихайи вводит концепцию "Потока" (Flow) — состояния полного погружения и наслаждения деятельностью, когда время пролетает незаметно, и мы чувствуем себя максимально реализованными. Это не пассивное удовольствие, а активное, требующее усилий, но приносящее глубокое удовлетворение. Книга исследует, как структурировать свою жизнь, чтобы чаще попадать в это оптимальное состояние и повышать качество жизни.</p>
                <h4 class="text-xl font-semibold mb-3">Ключевые идеи и цитаты (фрагмент):</h4>
                <p class="library-content">
                    **Условия Потока:** Состояние Потока возникает, когда уровень ваших навыков точно соответствует уровню сложности задачи. Если задача слишком проста, наступает скука; если слишком сложна — тревога. Идеальный баланс позволяет полностью сконцентрироваться на процессе. Ключевые условия: четкие цели, немедленная обратная связь и ощущение контроля над действиями.
                    <br><br>
                    **Автотелический опыт:** Это опыт, который ценен сам по себе, а не из-за внешней награды. Когда вы находитесь в Потоке, вы делаете это не ради денег, похвалы или достижения цели, а ради самого процесса. Жизнь, наполненная автотелическими переживаниями, — это жизнь, которую вы любите. Целью развития должно стать превращение большего количества рутинных действий в автотелические.
                    <br><br>
                    **Внутренний хаос и психическая энтропия:** Когда наше внимание направлено наружу на беспорядочные или пугающие внешние стимулы, наше сознание приходит в беспорядок, который Чиксентмихайи называет психической энтропией. Поток — это способ организации сознания, способ концентрации внимания на задачах, которые мы выбрали сами, что позволяет нам управлять внутренним опытом и устранять беспокойство.
                    <br><br>
                    **Расширение границ:** Чтобы продолжать испытывать Поток, мы должны постоянно повышать сложность своих задач по мере роста наших навыков. Это спираль развития: вы осваиваете навык, вам становится скучно, вы повышаете сложность, и снова входите в Поток на новом, более высоком уровне. Жизнь без этого расширения — это стагнация.
                    <br><br>
                    **Ключевая цитата:** «Самые лучшие моменты в нашей жизни — это не пассивные, принимающие, расслабляющие моменты... Самые лучшие моменты обычно происходят, когда тело или разум человека напряжены до предела в добровольном усилии достичь чего-то трудного и стоящего.»
                </p>
            `, quotes: ['Самые лучшие моменты происходят, когда тело или разум напряжены до предела в добровольном усилии.'] },
            'Книга 3': { title: 'Атомные привычки', author: 'Джеймс Клир', content: `
                <h4 class="text-xl font-semibold mb-3">О книге:</h4>
                <p class="mb-4">Джеймс Клир утверждает: чтобы добиться невероятных результатов, не нужно совершать революционные изменения. Достаточно ежедневно улучшать свои действия всего на 1%. Сосредоточьтесь на системе, а не на цели. Если вы будете становиться лучше на 1% каждый день, то через год вы будете лучше в 37 раз. Книга представляет простую, но мощную систему из 4 законов формирования привычек, которая работает независимо от вашей силы воли.</p>
                <h4 class="text-xl font-semibold mb-3">Ключевые идеи и цитаты (фрагмент):</h4>
                <p class="library-content">
                    **Система важнее цели:** Вы не поднимаетесь до уровня своих целей, а падаете до уровня своих систем. Если вы игнорируете систему маленьких шагов, то великие цели останутся мечтами. Сфокусируйтесь на процессе: создайте систему, которая делает прогресс неизбежным.
                    <br><br>
                    **Четыре закона изменения поведения:**
                    <ol class="list-decimal list-inside ml-4 mt-2 space-y-2">
                        <li>**Сделать очевидным:** Ваши хорошие привычки должны быть на виду. Используйте "Намерение реализации" (Я буду [Поведение] в [Время] в [Место]).</li>
                        <li>**Сделать привлекательным:** Используйте "Связывание по удовольствию" (Сделать [То, что нужно] + Сделать [То, что хочется]).</li>
                        <li>**Сделать легким:** Принцип "Минимально жизнеспособная привычка". Сведите действие к двум минутам. Хотите читать? Читайте 1 страницу.</li>
                        <li>**Сделать приносящим удовлетворение:** Сразу вознаграждайте себя. Используйте "Трекер привычек" — не прерывайте цепочку!</li>
                    </ol>
                    <br>
                    **Забытая истина о времени:** Ваши результаты — это запаздывающие индикаторы ваших привычек. Вы не увидите результатов после одного дня, но увидите их через год. Ваша жизнь сейчас — это сумма ваших прошлых привычек. Ваш успех не в том, чтобы сделать что-то раз в жизни, а в том, чтобы делать это *последовательно*.
                </p>
            `, quotes: ['Вы не поднимаетесь до уровня своих целей, а падаете до уровня своих систем.'] },
        };

        const AI_RESPONSES_DB = {
            general: [
                "Отличный вопрос! Помните: совершенство не в одном большом прорыве, а в сотне маленьких шагов, сделанных каждый день.",
                "Я внимательно вас слушаю. Прежде чем дать совет, скажите, что вы чувствуете по поводу своих текущих результатов?",
                "Давайте посмотрим на ситуацию с другой стороны. Какие ресурсы у вас уже есть, чтобы решить эту задачу?",
                "Как мудрец, Сайлас, могу сказать: не ищите ответа, ищите понимания. Что именно вам непонятно в текущей задаче?",
                "Джонни советует: избегайте прокрастинации. Если это занимает меньше 2 минут, сделайте это прямо сейчас.",
            ],
            give_up_explanation: (reason) => {
                if (reason.toLowerCase().includes('нет времени')) {
                    return `(${TRAINERS.johnny.name}) Время есть всегда, его просто нужно создать. Давайте пересмотрим ваше расписание: выделите 15 минут утром и 15 вечером. Согласны на этот эксперимент?`;
                }
                if (reason.toLowerCase().includes('сложно') || reason.toLowerCase().includes('тяжело')) {
                    return `(${TRAINERS.aurora.name}) Я понимаю, это тяжело, но вы не одни! Разбейте задачу на три крошечных шага. Первый шаг — сделать его на 50% легче. Что это будет?`;
                }
                return `(${TRAINERS.silas.name}) Спасибо за честность. Срыв — это обратная связь, а не неудача. Главный урок: не судите себя, а извлеките из этого опыта силу. Как мы можем изменить систему, чтобы это не повторилось?`;
            },
            task_complete: (taskText) => {
                return `(${TRAINERS.aurora.name}) Браво! Вы только что доказали себе, что можете это сделать. Отличная работа! Сохраните это ощущение победы и используйте его для следующей цели.`;
            },
            challenge_complete: (challengeName) => {
                return `(${TRAINERS.johnny.name}) Вы завершили челлендж "${challengeName}". Это не просто победа, это новый стандарт дисциплины. Гордитесь собой, но не расслабляйтесь! Вперед, к следующему уровню.`;
            }
        };


        // --- State Management (Local Storage Replacement) ---

        // Initialize Global State
        window.appState = {};

        /**
         * Loads the application state from localStorage.
         * Sets defaults if no state is found.
         */
        function loadState() {
            try {
                const storedState = localStorage.getItem('selfCoachAppState');
                const defaultState = {
                    activeTab: 'home',
                    tasks: {}, // { taskId: { completed: boolean, failed: boolean, explanation: string|null } }
                    challenges: {}, // { challengeId: { started: boolean, stepsCompleted: number } }
                    sleepDays: Array(28).fill(false), // [true, false, ...]
                    chatHistory: [],
                };

                if (storedState) {
                    window.appState = JSON.parse(storedState);
                    // Merge with defaults to ensure new fields are added if they weren't in old state
                    window.appState = { ...defaultState, ...window.appState };
                } else {
                    window.appState = defaultState;
                }
            } catch (error) {
                console.error("Ошибка загрузки состояния из LocalStorage:", error);
                // Fallback to defaults
                window.appState = {
                    activeTab: 'home', tasks: {}, challenges: {}, sleepDays: Array(28).fill(false), chatHistory: [],
                };
            }
            console.log("Состояние загружено:", window.appState);
        }

        /**
         * Saves the current application state to localStorage.
         */
        function saveState() {
            try {
                localStorage.setItem('selfCoachAppState', JSON.stringify(window.appState));
                console.log("Состояние сохранено.");
            } catch (error) {
                console.error("Ошибка сохранения состояния в LocalStorage:", error);
            }
        }


        // --- Utility Functions ---

        /**
         * Shows a custom modal message instead of alert().
         * @param {string} title
         * @param {string} message
         */
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('app-modal').classList.remove('hidden');
        }

        function switchTab(tabId) {
            window.appState.activeTab = tabId;
            saveState();
            renderApp();
        }

        function getMotivationalPhrase() {
            const index = Math.floor(Math.random() * MOTIVATIONAL_PHRASES.length);
            return MOTIVATIONAL_PHRASES[index];
        }

        // --- Renderer Functions ---

        function renderTabs() {
            const nav = document.getElementById('app-navigation');
            nav.innerHTML = TABS.map(tab => `
                <button
                    class="tab-button ${window.appState.activeTab === tab.id ? 'active' : ''} text-lg"
                    onclick="switchTab('${tab.id}')"
                >
                    <i class="${tab.icon} mr-2"></i> ${tab.name}
                </button>
            `).join('');
        }

        // --- TAB: HOME ---
        function renderHome() {
            const totalTasks = Object.keys(TASKS_DATA).reduce((sum, key) => sum + TASKS_DATA[key].length, 0);
            const completedTaskCount = Object.values(window.appState.tasks).filter(t => t.completed).length;

            const totalChallenges = CHALLENGES_DATA.length;
            const completedChallengesCount = CHALLENGES_DATA.filter(c => {
                const state = window.appState.challenges[c.id];
                return state && state.stepsCompleted === c.steps.length;
            }).length;

            const sleepProgress = window.appState.sleepDays.filter(d => d).length;

            return `
                <div class="space-y-10">
                    <div class="p-6 bg-indigo-50 rounded-2xl border border-indigo-200">
                        <h2 class="text-2xl font-bold text-indigo-700 mb-2">Добро пожаловать обратно!</h2>
                        <p class="text-gray-700 text-lg">${getMotivationalPhrase()}</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Card 1: Tasks Progress -->
                        <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                            <i class="fas fa-tasks text-3xl text-indigo-500 mb-3"></i>
                            <h3 class="text-xl font-semibold mb-2">Прогресс по Заданиям</h3>
                            <div class="text-4xl font-extrabold text-gray-800">${completedTaskCount} / ${totalTasks}</div>
                            <div class="h-2 bg-gray-200 rounded-full mt-3">
                                <div class="h-2 bg-indigo-500 rounded-full" style="width: ${Math.round((completedTaskCount / totalTasks) * 100) || 0}%"></div>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Выполнено ${Math.round((completedTaskCount / totalTasks) * 100) || 0}% всех микро-задач.</p>
                        </div>

                        <!-- Card 2: Challenges Progress -->
                        <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                            <i class="fas fa-running text-3xl text-violet-500 mb-3"></i>
                            <h3 class="text-xl font-semibold mb-2">Пройденные Челленджи</h3>
                            <div class="text-4xl font-extrabold text-gray-800">${completedChallengesCount} / ${totalChallenges}</div>
                            <div class="h-2 bg-gray-200 rounded-full mt-3">
                                <div class="h-2 bg-violet-500 rounded-full" style="width: ${Math.round((completedChallengesCount / totalChallenges) * 100) || 0}%"></div>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Сила привычки растет с каждым завершением!</p>
                        </div>

                        <!-- Card 3: Sleep Tracker -->
                        <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                            <i class="fas fa-bed text-3xl text-emerald-500 mb-3"></i>
                            <h3 class="text-xl font-semibold mb-2">Трекер "Здоровый Сон"</h3>
                            <div class="text-4xl font-extrabold text-gray-800">${sleepProgress} / 28</div>
                            <div class="h-2 bg-gray-200 rounded-full mt-3">
                                <div class="h-2 bg-emerald-500 rounded-full" style="width: ${Math.round((sleepProgress / 28) * 100) || 0}%"></div>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Прогресс на пути к идеальной гигиене сна.</p>
                        </div>
                    </div>

                    <!-- Trainer Section -->
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 pt-4 border-t">Ваши AI-Тренеры</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${Object.values(TRAINERS).map(trainer => `
                            <div class="p-5 rounded-xl shadow-md border ${trainer.bg}">
                                <div class="flex items-center mb-3">
                                    <i class="${trainer.icon} text-2xl ${trainer.color} mr-3"></i>
                                    <h4 class="font-bold text-lg text-gray-800">${trainer.name}</h4>
                                </div>
                                <p class="text-sm text-gray-600 mb-3">${trainer.role}</p>
                                <p class="text-xs text-gray-500">${trainer.description}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- TAB: TASKS (Fixed Logic) ---

        function renderTasks() {
            let html = '<div class="space-y-10">';

            Object.entries(TASKS_DATA).forEach(([sphereKey, tasks]) => {
                const sphereName = SPHERES[sphereKey];

                const completedCount = tasks.filter(task => window.appState.tasks[task.id] && window.appState.tasks[task.id].completed).length;

                html += `
                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                        <h2 class="text-2xl font-extrabold text-gray-800 mb-2">${sphereName}</h2>
                        <div class="text-sm text-gray-500 mb-6">Прогресс: ${completedCount} / ${tasks.length}</div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${tasks.map(task => {
                                const state = window.appState.tasks[task.id] || { completed: false, failed: false, explanation: null };
                                const isCompleted = state.completed;
                                const isFailed = state.failed;

                                return `
                                    <div class="task-card p-4 rounded-xl shadow-sm border ${isCompleted ? 'completed border-green-200' : isFailed ? 'border-red-300 bg-red-50' : 'border-gray-200 bg-white'}">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${isCompleted ? 'bg-green-100 text-green-700' : isFailed ? 'bg-red-200 text-red-700' : 'bg-indigo-100 text-indigo-700'}">
                                                Уровень ${task.level}
                                            </span>
                                            ${isCompleted ? '<i class="fas fa-check-circle text-xl text-green-500"></i>' : isFailed ? '<i class="fas fa-times-circle text-xl text-red-500"></i>' : ''}
                                        </div>
                                        <p class="text-gray-700 text-sm mb-4 ${isCompleted ? 'line-through text-gray-500' : ''}">${task.text}</p>
                                        <div class="flex space-x-2">
                                            ${!isCompleted && !isFailed ? `
                                                <button onclick="completeTask('${task.id}', true)" class="flex-1 py-2 text-xs font-semibold rounded-lg bg-green-500 text-white hover:bg-green-600 transition-colors">
                                                    <i class="fas fa-check mr-1"></i> Выполнено
                                                </button>
                                                <button onclick="showGiveUpModal('${task.id}')" class="flex-1 py-2 text-xs font-semibold rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors">
                                                    <i class="fas fa-hand-paper mr-1"></i> Сдаться
                                                </button>
                                            ` : isFailed ? `
                                                <p class="text-xs text-red-600 italic">Срыв. Объяснение: ${state.explanation}</p>
                                                <button onclick="completeTask('${task.id}', false, true)" class="py-1 px-2 text-xs font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                                                    Перезапустить
                                                </button>
                                            ` : `
                                                <p class="text-xs text-green-600 font-medium">Задача выполнена!</p>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        /**
         * Marks a task as complete or failed (or resets it).
         * This function was missing/broken in the previous version.
         * @param {string} taskId
         * @param {boolean} isCompleted
         * @param {boolean} [isReset=false]
         */
        function completeTask(taskId, isCompleted, isReset = false) {
            if (isReset) {
                delete window.appState.tasks[taskId];
                showModal('Задача перезапущена', 'Вы можете попробовать выполнить ее снова.');
            } else {
                window.appState.tasks[taskId] = {
                    completed: isCompleted,
                    failed: !isCompleted,
                    explanation: isCompleted ? null : window.appState.currentGiveUpExplanation || 'Не указано',
                };
                if (isCompleted) {
                    handleAiQuery(`[System] Задача ${taskId} выполнена.`, 'ai'); // Notify AI
                    showModal('Отличная работа!', 'Задача отмечена как выполненная. Выберите следующую цель!');
                } else {
                    handleAiQuery(`[System] Задача ${taskId} провалена по причине: ${window.appState.currentGiveUpExplanation}`, 'ai'); // Notify AI
                    showModal('Урок усвоен', 'Тренер получил ваше объяснение. Неудача — это просто обратная связь. Попробуйте снова или выберите более легкую цель.');
                }
            }
            window.appState.currentGiveUpTask = null;
            window.appState.currentGiveUpExplanation = null;
            document.getElementById('give-up-modal').classList.add('hidden');
            saveState();
            renderApp();
        }

        function showGiveUpModal(taskId) {
            window.appState.currentGiveUpTask = taskId;
            document.getElementById('give-up-modal').classList.remove('hidden');
            document.getElementById('give-up-explanation').value = '';
        }

        // Handle give up form submission
        document.getElementById('give-up-form').onsubmit = (e) => {
            e.preventDefault();
            const explanation = document.getElementById('give-up-explanation').value.trim() || 'Причина не указана';
            if (window.appState.currentGiveUpTask) {
                window.appState.currentGiveUpExplanation = explanation;
                completeTask(window.appState.currentGiveUpTask, false);
            }
        };

        // --- TAB: CHALLENGES ---

        function renderChallenges() {
            let html = '<div class="space-y-8">';
            html += '<h2 class="text-3xl font-bold text-gray-800 mb-6">Прокачай себя: Долгосрочные Челленджи</h2>';

            html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;

            CHALLENGES_DATA.forEach(challenge => {
                const state = window.appState.challenges[challenge.id] || { started: false, stepsCompleted: 0 };
                const totalSteps = challenge.steps.length;
                const progress = Math.round((state.stepsCompleted / totalSteps) * 100);
                const isCompleted = state.stepsCompleted === totalSteps;

                const colorClass = challenge.id === 'C1' ? 'bg-indigo-500' : challenge.id === 'C2' ? 'bg-red-500' : challenge.id === 'C3' ? 'bg-emerald-500' : 'bg-violet-500';

                html += `
                    <div class="challenge-card p-6 rounded-2xl shadow-lg border border-gray-100 ${isCompleted ? 'opacity-80' : 'bg-white'}">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">${challenge.name} (${challenge.duration} дней)</h3>
                            ${isCompleted ? '<span class="text-green-600 font-semibold"><i class="fas fa-trophy mr-1"></i> ЗАВЕРШЕН</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Фокус: <span class="font-medium text-gray-700">${challenge.focus}</span></p>

                        ${state.started ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium mb-1">Прогресс:</p>
                                <div class="h-2 bg-gray-200 rounded-full">
                                    <div class="h-2 ${colorClass} rounded-full" style="width: ${progress}%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${state.stepsCompleted} из ${totalSteps} шагов.</p>
                            </div>

                            <ul class="space-y-3 mb-6">
                                ${challenge.steps.map((step, index) => {
                                    const stepIndex = index + 1;
                                    const isStepCompleted = stepIndex <= state.stepsCompleted;
                                    return `
                                        <li class="flex items-start text-sm ${isStepCompleted ? 'text-gray-500 line-through' : 'text-gray-700'}">
                                            <i class="fas ${isStepCompleted ? 'fa-check-square text-green-500' : 'fa-square text-gray-400'} mt-1 mr-3"></i>
                                            <span class="${isStepCompleted ? 'text-gray-500' : ''}">${step}</span>
                                        </li>
                                    `;
                                }).join('')}
                            </ul>

                            <button
                                onclick="completeChallengeStep('${challenge.id}')"
                                ${isCompleted ? 'disabled' : ''}
                                class="w-full py-3 font-semibold rounded-xl transition-colors ${isCompleted ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : `${colorClass} text-white hover:opacity-90`}">
                                <i class="fas fa-angle-double-right mr-2"></i> ${isCompleted ? 'Челлендж завершен!' : `Отметить Шаг ${state.stepsCompleted + 1} как выполненный`}
                            </button>
                        ` : `
                            <p class="text-gray-600 mb-6">Это челлендж для формирования устойчивой привычки. Он требует дисциплины и ежедневного контроля.</p>
                            <button onclick="startChallenge('${challenge.id}')" class="w-full py-3 font-semibold rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
                                <i class="fas fa-play-circle mr-2"></i> Начать Челлендж
                            </button>
                        `}
                    </div>
                `;
            });

            html += '</div></div>';
            return html;
        }

        function startChallenge(challengeId) {
            window.appState.challenges[challengeId] = { started: true, stepsCompleted: 0 };
            saveState();
            renderApp();
            showModal('Челлендж Начался!', 'Успех — это постепенная реализация достойной цели. Начните прямо сейчас!');
        }

        function completeChallengeStep(challengeId) {
            const state = window.appState.challenges[challengeId];
            const challenge = CHALLENGES_DATA.find(c => c.id === challengeId);

            if (state.stepsCompleted < challenge.steps.length) {
                state.stepsCompleted += 1;
                if (state.stepsCompleted === challenge.steps.length) {
                    handleAiQuery(`[System] Челлендж "${challenge.name}" завершен.`, 'ai');
                    showModal('ПОБЕДА!', `Вы успешно завершили челлендж "${challenge.name}"! Ваш тренер очень гордится вашей дисциплиной.`);
                } else {
                    showModal('Шаг сделан!', `Отлично! Вы на ${state.stepsCompleted} шаге из ${challenge.steps.length}.`);
                }
                saveState();
                renderApp();
            }
        }


        // --- TAB: HEALTHY SLEEP (Fixed Logic) ---

        function renderHealthySleep() {
            const sleepProgress = window.appState.sleepDays.filter(d => d).length;
            const percentage = Math.round((sleepProgress / 28) * 100);
            const currentDay = sleepProgress + 1;

            let html = `
                <div class="space-y-8">
                    <div class="p-6 bg-emerald-50 rounded-2xl border border-emerald-200 shadow-lg">
                        <h2 class="text-3xl font-bold text-emerald-700 mb-2">28 Дней Здорового Сна</h2>
                        <p class="text-gray-700 mb-4">Последовательное улучшение привычек сна для повышения энергии и концентрации.</p>

                        <div class="mb-4">
                            <p class="text-sm font-medium mb-1 text-gray-700">Общий прогресс: ${sleepProgress} / 28 дней</p>
                            <div class="h-3 bg-gray-200 rounded-full">
                                <div class="h-3 bg-emerald-500 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${percentage}% завершено.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${SLEEP_PLAN.map(dayPlan => {
                            const dayIndex = dayPlan.day - 1;
                            const isCompleted = window.appState.sleepDays[dayIndex];
                            const isPast = dayPlan.day <= currentDay;
                            const isDisabled = dayPlan.day > currentDay;

                            return `
                                <div class="sleep-day-card p-5 rounded-xl shadow-md border ${isCompleted ? 'completed border-green-300' : isDisabled ? 'bg-gray-50 border-gray-200' : 'bg-white border-indigo-100'}">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="text-xl font-bold ${isCompleted ? 'text-green-700' : isDisabled ? 'text-gray-400' : 'text-indigo-700'}">
                                            День ${dayPlan.day}: ${dayPlan.title}
                                        </h4>
                                        ${isCompleted ? '<i class="fas fa-check-circle text-2xl text-green-500"></i>' : ''}
                                    </div>
                                    <p class="text-sm ${isCompleted ? 'text-gray-500 line-through' : isDisabled ? 'text-gray-400' : 'text-gray-700'} mb-3">${dayPlan.task}</p>
                                    <p class="text-xs text-gray-500 italic mb-4">Цель: ${dayPlan.benefit}</p>

                                    ${!isCompleted && isPast ? `
                                        <button onclick="completeSleepDay(${dayPlan.day})" class="w-full py-2 text-sm font-semibold rounded-lg bg-emerald-500 text-white hover:bg-emerald-600 transition-colors">
                                            <i class="fas fa-bed mr-2"></i> Отметить как выполненный
                                        </button>
                                    ` : isDisabled ? `
                                        <button disabled class="w-full py-2 text-sm font-semibold rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed">
                                            <i class="fas fa-lock mr-2"></i> Доступно на День ${dayPlan.day}
                                        </button>
                                    ` : isCompleted ? `
                                        <p class="text-xs text-green-600 font-medium text-center">Выполнено. Привычка закрепляется!</p>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            return html;
        }

        /**
         * Marks a sleep day as complete.
         * This function was missing/broken in the previous version.
         * @param {number} dayNumber
         */
        function completeSleepDay(dayNumber) {
            const index = dayNumber - 1;
            if (index >= 0 && index < 28 && !window.appState.sleepDays[index]) {
                const currentProgress = window.appState.sleepDays.filter(d => d).length;
                if (dayNumber !== currentProgress + 1) {
                    showModal('Подождите', 'Вы должны выполнить задания предыдущих дней по порядку.');
                    return;
                }

                window.appState.sleepDays[index] = true;
                saveState();
                renderApp();

                if (dayNumber === 28) {
                    showModal('Поздравляем!', 'Вы прошли весь 28-дневный челлендж по сну. Ваши циркадные ритмы теперь настроены идеально!');
                } else {
                    showModal('Отлично!', `День ${dayNumber} завершен. Завтра — новая ступень!`);
                }
            } else {
                 showModal('Ошибка', 'Этот день либо уже выполнен, либо недоступен для выполнения.');
            }
        }

        // --- TAB: LIBRARY ---

        function renderLibrary() {
            const bookTitles = Object.keys(LIBRARY_DATA);

            let html = '<div class="space-y-8">';
            html += '<h2 class="text-3xl font-bold text-gray-800 mb-6">Библиотека Мудрости</h2>';

            html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-6">`;
            bookTitles.forEach(key => {
                const book = LIBRARY_DATA[key];
                const trainerKey = key === 'Книга 1' ? 'silas' : key === 'Книга 2' ? 'aurora' : 'johnny';
                const trainer = TRAINERS[trainerKey];

                html += `
                    <div class="p-5 rounded-xl shadow-lg border border-gray-100 bg-white hover:shadow-xl transition-shadow cursor-pointer" onclick="showBookContent('${key}')">
                        <i class="fas fa-book text-3xl ${trainer.color} mb-3"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-1">${book.title}</h3>
                        <p class="text-sm text-gray-500 mb-3">Автор: ${book.author}</p>
                        <p class="text-xs text-gray-600 italic">"«${book.quotes[0]}»"</p>
                        <button class="mt-4 text-xs font-semibold text-indigo-600 hover:text-indigo-800">Читать полностью <i class="fas fa-arrow-right ml-1"></i></button>
                    </div>
                `;
            });
            html += `</div>`;
            html += `</div>`;
            return html;
        }

        function showBookContent(bookTitle) {
            const book = LIBRARY_DATA[bookTitle];
            showModal(book.title, book.content);
        }

        // --- TAB: CHAT (Simulated AI) ---

        /**
         * Renders the chat interface.
         */
        function renderChat() {
            return `
                <div class="flex flex-col h-full max-h-[70vh] bg-white rounded-xl shadow-lg border border-gray-100">
                    <!-- Chat History Area -->
                    <div id="chat-messages" class="flex-grow p-6 space-y-4 overflow-y-auto custom-scrollbar">
                        ${window.appState.chatHistory.map(msg => renderChatMessage(msg)).join('')}
                    </div>

                    <!-- Input Area -->
                    <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-xl">
                        <form id="chat-form" onsubmit="event.preventDefault(); sendMessage()">
                            <div class="flex items-center">
                                <textarea id="chat-input" rows="1" class="flex-grow w-full p-3 border border-gray-300 rounded-xl resize-none focus:ring-indigo-500 focus:border-indigo-500 custom-scrollbar" placeholder="Спросите вашего тренера..."></textarea>
                                <button type="submit" class="ml-3 p-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderChatMessage(msg) {
            const isUser = msg.role === 'user';
            const trainer = TRAINERS[msg.trainerKey || 'silas']; // Default to Silas

            return `
                <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-3/4 p-4 rounded-xl shadow-md text-sm ${isUser ? 'chat-message-user' : 'chat-message-ai'}">
                        ${!isUser ? `<div class="font-bold mb-1 ${trainer.color}">${trainer.name} (${trainer.role})</div>` : ''}
                        <p class="whitespace-pre-wrap">${msg.text}</p>
                    </div>
                </div>
            `;
        }

        /**
         * Sends user message and generates a simulated AI response.
         */
        function sendMessage() {
            const inputElement = document.getElementById('chat-input');
            const userQuery = inputElement.value.trim();

            if (!userQuery) return;

            // 1. Add user message
            window.appState.chatHistory.push({ role: 'user', text: userQuery });
            saveState();

            // 2. Clear input and scroll down
            inputElement.value = '';
            scrollChatToBottom();

            // 3. Generate simulated AI response (delayed for realism)
            setTimeout(() => {
                const aiResponse = handleAiQuery(userQuery, 'user');
                window.appState.chatHistory.push(aiResponse);
                saveState();
                renderApp();
                scrollChatToBottom();
            }, 1000); // Simulate network delay
        }

        /**
         * Simulated AI response handler based on user query and predefined data.
         * @param {string} query
         * @param {'user'|'ai'} role - 'user' for user messages, 'ai' for system notifications (e.g., task complete).
         * @returns {{role: string, text: string, trainerKey: string}}
         */
        function handleAiQuery(query, role) {
            let responseText = '';
            let trainerKey = 'silas';
            const lowerQuery = query.toLowerCase();
            const randomTrainer = Object.keys(TRAINERS)[Math.floor(Math.random() * 3)];

            if (role === 'ai') {
                if (lowerQuery.includes('задача') && lowerQuery.includes('выполнена')) {
                    responseText = AI_RESPONSES_DB.task_complete();
                    trainerKey = 'aurora';
                } else if (lowerQuery.includes('челлендж') && lowerQuery.includes('завершен')) {
                    const match = query.match(/"(.*?)"/);
                    const challengeName = match ? match[1] : 'успешный';
                    responseText = AI_RESPONSES_DB.challenge_complete(challengeName);
                    trainerKey = 'johnny';
                } else if (lowerQuery.includes('провалена') || lowerQuery.includes('срыв') || lowerQuery.includes('сдаться')) {
                    const explanation = window.appState.currentGiveUpExplanation || 'Не указано';
                    responseText = AI_RESPONSES_DB.give_up_explanation(explanation);
                    trainerKey = 'johnny';
                }
            } else { // Handle user query
                if (lowerQuery.includes('мотивация') || lowerQuery.includes('начни') || lowerQuery.includes('лень')) {
                    responseText = `(${TRAINERS.aurora.name}) ${AI_RESPONSES_DB.general[0]}`;
                    trainerKey = 'aurora';
                } else if (lowerQuery.includes('прогресс') || lowerQuery.includes('цель') || lowerQuery.includes('оценка')) {
                    const completedTasks = Object.values(window.appState.tasks).filter(t => t.completed).length;
                    const totalTasks = Object.keys(TASKS_DATA).reduce((sum, key) => sum + TASKS_DATA[key].length, 0);
                    responseText = `(${TRAINERS.silas.name}) Вы молодец! На данный момент вы выполнили **${completedTasks} из ${totalTasks}** задач. Это отличный фундамент. В какой сфере вам сейчас нужна наибольшая поддержка?`;
                    trainerKey = 'silas';
                } else if (lowerQuery.includes('расписание') || lowerQuery.includes('план') || lowerQuery.includes('как')) {
                    responseText = `(${TRAINERS.johnny.name}) Планирование — это половина битвы! Начните с **принципа "2-х минут"**: если что-то можно сделать за 2 минуты, сделайте это немедленно. С какой конкретной задачей вы хотите начать сегодня?`;
                    trainerKey = 'johnny';
                } else {
                    // Default random response
                    responseText = `(${TRAINERS[randomTrainer].name}) ${AI_RESPONSES_DB.general[Math.floor(Math.random() * AI_RESPONSES_DB.general.length)]}`;
                    trainerKey = randomTrainer;
                }
            }

            return { role: 'ai', text: responseText, trainerKey };
        }

        function scrollChatToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                // Ensure the content is rendered before scrolling (small delay helps)
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }
        }


        // --- Main App Renderer ---

        function renderApp() {
            const contentArea = document.getElementById('content-area');
            const loadingIndicator = document.getElementById('loading-indicator');

            // 1. Hide loading
            if (loadingIndicator) loadingIndicator.classList.add('hidden');

            // 2. Render Navigation
            renderTabs();

            // 3. Render Content based on active tab
            let contentHTML = '';
            switch (window.appState.activeTab) {
                case 'home':
                    contentHTML = renderHome();
                    break;
                case 'tasks':
                    contentHTML = renderTasks();
                    break;
                case 'challenges':
                    contentHTML = renderChallenges();
                    break;
                case 'healthy_sleep':
                    contentHTML = renderHealthySleep();
                    break;
                case 'library':
                    contentHTML = renderLibrary();
                    break;
                case 'chat':
                    contentHTML = renderChat();
                    scrollChatToBottom();
                    break;
                default:
                    contentHTML = renderHome();
                    break;
            }
            contentArea.innerHTML = contentHTML;

            // Re-apply scrolling if we are on the chat tab
            if (window.appState.activeTab === 'chat') {
                scrollChatToBottom();
            }
        }


        // --- Initialization ---

        window.onload = function() {
            loadState();
            renderApp();
            console.log("Приложение успешно инициализировано в автономном режиме.");
        };

        // Make key functions globally accessible for inline onclick handlers
        window.switchTab = switchTab;
        window.completeTask = completeTask;
        window.showGiveUpModal = showGiveUpModal;
        window.startChallenge = startChallenge;
        window.completeChallengeStep = completeChallengeStep;
        window.completeSleepDay = completeSleepDay;
        window.showBookContent = showBookContent;
        window.sendMessage = sendMessage;
        window.handleAiQuery = handleAiQuery; // For system calls
        window.showModal = showModal; // For modals

    </script>
</body>
</html>
